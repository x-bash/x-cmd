#! /bin/sh
# shellcheck disable=SC2006,SC1091,SC3043

if [ -z "$___X_CMD_ROOT" ]; then
    local IFS="
"

    local line
    while read -r line; do
        if [ -f "$line/xrc/latest" ]; then
            ___X_CMD_ROOT="$line"
            return
        fi
    done <<A
$(pwd)/.x-cmd
$HOME/.x-cmd
/var/.x-cmd
/usr/bin/.x-cmd
A

    cat >&2 <<A
No x-cmd found in this computer.
Type following cmd to setup:        eval `x init`
If you need help, type:             eval `x help`
A
    exit 1
fi

___X_CMD_XBIN_CODE="$(cat <<A
# This should be executed by:       eval `x init`
# If you need help, type:           eval `x help`

. "${___X_CMD_ROOT}/xrc/latest";
x boot setup;
A
)"

___x_cmd_xbin_init(){
    if [ ! -t 1 ]; then
        cat >&2 <<A
This should be executed by:   eval `x init`
If you need help, type:       eval `x help`
A
        return 1
    fi
    if [ -n "$___X_CMD_ROOT" ]; then
        printf "%s" "$___X_CMD_XBIN_CODE"
    else
        printf "%s" "curl https://get.x-cmd.com"
    fi
}

x(){
    if [ "$1" = init ]; then
        ___x_cmd_xbin_init
        return
    fi

    . "$___X_CMD_ROOT/xrc/latest"
    x "$@"
}
