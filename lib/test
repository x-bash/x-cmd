# shellcheck disable=SC1090,SC1091
# load in need

x log init test
___x_cmd_ui_sep(){
    awk -v sep="${1:-—}" -v maxw="${2:-$COLUMNS}" 'BEGIN{ for(i=1;i<=maxw;i++){ c=c sep; }; print c}'
    # printf "%0.s${1:-—}" {1..${2:-$COLUMNS}}
    # printf "%0.s${1:-—}" $(seq 1 "${2:-$COLUMNS}")
    printf "\n"
}

___x_cmd_test(){
    ___x_cmd_test_main "$@"
}

___x_cmd_test_main(){
    local target="${1}"
    if [ -z "$target" ]; then
        target="$(x wsroot)/.x-cmd/testcase"
    fi
    if [ ! -d "$target" ]; then
        test:warn "Expecting to be folder: $target"
        return 1
    fi

    # printf "%s\n" "-------------------"
    ___x_cmd_ui_sep "━"
    (
        cd "$target" && NAME="" INDENT="" ___x_cmd_test_folder "$(pwd)"
    )
    local code="$?"
    ___x_cmd_ui_sep "━"
    # printf "%s\n" "-------------------"

    return "$code"
}

___x_cmd_test_folder(){

    local testcase
    local global_code=0
    local code
    for testcase in *; do
        case "$testcase" in
            setup|teardown)         continue ;;
        esac

        ( ___x_cmd_test___folder_exec "$@" )
        code=$?

        if [ -n "$___X_CMD_TEST_ERR_EXIT" ]; then
            [ $code -ne 0 ] && return "$code"
        fi

        [ $code -ne 0 ] && global_code=1
    done
    return "$global_code"
}

___x_cmd_test___folder_exec() {
    if [ -f "$testcase" ]; then
        # printf "\033[36m%s\033[0m" "${INDENT}-[ ] $testcase"

        [ -f ./setup ] && . ./setup

        local err
        err="$(. "./$testcase" 2>/dev/stdout)"
        code="$?"
        test:debug "testcase: $testcase code: $code err: $err"
        [ -f ./teardown ] &&  . ./teardown

        if [ $code -eq 0 ]; then
            printf "\033[32m%s\033[0m\n" "${INDENT}-[Y] $NAME $testcase"
        else
            printf "\033[1;31m%s\033[0m\n" "${INDENT}-[X] $NAME $testcase"
            printf "\033[2m%s\n" "$(___x_cmd_ui_sep "~" $(( $(___x_cmd_ui cols) / 3 )) ) <out+err> "
            printf "\033[2;33m%s\033[0m\n" "$err"
            printf "\033[2m%s\033[0m\n" "$(___x_cmd_ui_sep "~" $(( $(___x_cmd_ui cols) / 3 )) ) <end>"
        fi
        return "$code"

    elif [ -d "$testcase" ]; then
        cd "$testcase" || return 1

        printf "\033[1;34m%s\033[0m\n" "${INDENT}>>> $NAME $testcase"
        [ -f ./setup ] && . ./setup
        NAME="$NAME/$testcase" INDENT="${INDENT}    " \
            ___x_cmd_test_folder "$(pwd)"
        code=$?
        [ -f ./teardown ] &&  . ./teardown
        s="$(___x_cmd_ui_sep '─')"
        printf "\033[34m%s\033[0m\n" "${s}" # "${INDENT}--- ${s#────}"
        return "$code"
    else
        :
    fi
}
